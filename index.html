<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Magic Class ‚Ä¢ EDcoins & Superpowers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* * ==============================================
     * THEME & COLOR PALETTE
     * ==============================================
     */
    :root {
      --bg-dark: #1a1b26;
      --bg-med: #24283b;
      --bg-light: #414868;
      --panel: #1f202e;
      --text: #c0caf5;
      --text-dark: #a9b1d6;
      --accent-primary: #bb9af7;
      --accent-secondary: #7aa2f7;
      --accent-green: #9ece6a;
      --accent-yellow: #e0af68;
      --accent-red: #f7768e;
      --shadow: 0 10px 30px rgba(0,0,0,.4);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Poppins', sans-serif;
    }
    
    body.light-mode {
      --bg-dark: #f0f2f5;
      --bg-med: #ffffff;
      --bg-light: #e4e6eb;
      --panel: #ffffff;
      --text: #050505;
      --text-dark: #65676b;
      --accent-primary: #8a3ffc;
      --accent-secondary: #0062ff;
      --accent-green: #34a853;
      --accent-yellow: #fbbc05;
      --accent-red: #ea4335;
      --shadow: 0 4px 12px rgba(0,0,0,.1);
    }

    /* * ==============================================
     * BASE & LAYOUT STYLES
     * ==============================================
     */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg-dark);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      scrollbar-color: var(--bg-light) var(--bg-dark);
      font-size: 15px;
    }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--bg-light); border-radius: 5px; border: 2px solid var(--bg-dark); }
    ::-webkit-scrollbar-thumb:hover { background: #565f89; }
    body.light-mode ::-webkit-scrollbar-thumb:hover { background: #b0b3b8; }
    
    .app {
      display: grid;
      grid-template-columns: 310px 1fr;
      gap: 20px;
      padding: 20px;
      margin: auto;
    }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(187, 154, 247, .1);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }
    body.light-mode .panel { border-color: rgba(0,0,0,.1); }

    .sidebar { padding: 20px; display: flex; flex-direction: column; gap: 18px; position: relative; }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid rgba(187, 154, 247, .1);
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
    body.light-mode .header { border-bottom-color: rgba(0,0,0,.1); }
    .title { font-size: 22px; font-weight: 700; letter-spacing: .5px; color: var(--accent-primary); }
    .muted { color: var(--text-dark); opacity: .8; }
    hr.divider { border:none; border-top:1px solid var(--bg-light); margin: 8px 0; }

    /* * ==============================================
     * UI COMPONENTS (Buttons, Inputs, Cards)
     * ==============================================
     */
    input[type="text"], input[type="number"], textarea, select {
      background: var(--bg-med);
      color: var(--text);
      border: 1px solid var(--bg-light);
      border-radius: var(--radius-md);
      padding: 10px 14px;
      outline: none;
      width: 100%;
      transition: var(--transition);
      font-size: 15px;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent-secondary); box-shadow: 0 0 0 3px rgba(122, 162, 247, .2); }
    body.light-mode input:focus, body.light-mode textarea:focus, body.light-mode select:focus { box-shadow: 0 0 0 3px rgba(0, 98, 255, .2); }
    textarea { min-height: 98px; resize: vertical; }

    .btn {
      border: none;
      background: var(--bg-light);
      color: var(--text);
      padding: 10px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: var(--transition);
      font-weight: 500;
      position: relative;
      overflow: hidden;
      white-space: nowrap;
    }
    .btn:hover { background: #565f89; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,.3); }
    body.light-mode .btn:hover { background: #dcdfe4; }
    .btn:active { transform: translateY(0); }
    .btn.primary { background: linear-gradient(135deg, var(--accent-primary), #9a7ecc); color: var(--bg-dark); font-weight: 700; }
    body.light-mode .btn.primary { color: #fff; }
    .btn.primary:hover { filter: brightness(1.1); }
    .btn.warning { background: var(--accent-red); color: var(--bg-dark); font-weight: 700; }
    body.light-mode .btn.warning { color: #fff; }
    .btn.ghost { background: transparent; border: 1px solid var(--bg-light); }
    .btn.small { padding: 6px 10px; border-radius: var(--radius-sm); font-size: 13px; }
    .btn.icon { padding: 8px; width: 38px; height: 38px; font-size: 16px; }

    .card {
      background: var(--panel);
      border: 1px solid rgba(187, 154, 247, .1);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    body.light-mode .card { border-color: rgba(0,0,0,.1); }
    .card h3 {
      margin: 0;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(187, 154, 247, .1);
      font-size: 16px;
      background: rgba(0,0,0,.1);
    }
    body.light-mode .card h3 { border-bottom-color: rgba(0,0,0,.1); background: rgba(0,0,0,.03); }
    .card .body { padding: 16px 20px; display: flex; flex-direction: column; gap: 14px; }
    
    .chip {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      padding: 6px 12px;
      background: var(--bg-light);
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid transparent;
      font-weight: 500;
    }
    .chip.power-icon { cursor: pointer; transition: var(--transition); }
    .chip.power-icon:hover { background: var(--accent-red); color: var(--bg-dark); transform: scale(1.1); }
    body.light-mode .chip.power-icon:hover { color: #fff; }

    /* * ==============================================
     * SPECIFIC SECTIONS & TABLES
     * ==============================================
     */
    .class-list {
      display: grid;
      grid-template-columns: repeat(2, auto);
      justify-content: start;
      align-content: start;
      gap: 10px;
      height: 230px;
      overflow-y: auto;
      padding-right: 6px; /* Space for scrollbar */
    }
    .class-list:empty {
      border: 1px dashed var(--bg-light);
      border-radius: var(--radius-md);
      display: grid;
      place-items: center;
      grid-template-columns: 1fr;
      padding: 0;
    }
    .class-list:empty::before {
    margin-top: 100px;
        content: 'empty';
        color: var(--text-dark);
        font-style: italic;
    }
    .class-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      background: var(--bg-med);
      border: 1px solid var(--bg-light);
      cursor: pointer;
      transition: var(--transition);
    }
    .class-item:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,.3); border-color: var(--accent-secondary); }
    .class-item.active { border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(187, 154, 247, .3); }
    body.light-mode .class-item.active { box-shadow: 0 0 0 3px rgba(138, 63, 252, .3); }
     
    .cards { display: grid; grid-template-columns: 1fr; gap: 24px; }
    @media(min-width: 920px){ .cards{ grid-template-columns: 1fr 360px } }
    
    .table-container { max-height: 580px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left;
      font-size: 13px;
      color: var(--text-dark);
      font-weight: 600;
      padding: 12px 16px;
      background: var(--panel);
      position: sticky; top: 0; z-index: 1;
      border-bottom: 1px solid var(--bg-light);
    }
    tbody tr { transition: background-color .2s ease; }
    tbody tr:hover { background-color: rgba(122, 162, 247, .08); }
    body.light-mode tbody tr:hover { background-color: rgba(0, 98, 255, .08); }
    tbody td { padding: 8px 16px; border-bottom: 1px solid var(--bg-med); } 
    body.light-mode tbody td { border-bottom: 1px solid var(--bg-light); }
    .name-cell { display: flex; align-items: center; gap: 12px; }
    .avatar {
      width: 36px; height: 36px;
      border-radius: var(--radius-sm);
      display: grid; place-items: center;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: var(--bg-dark);
      font-weight: 700;
      font-size: 16px;
    }
    body.light-mode .avatar { color: #fff; }
    .powers { display: flex; gap: 6px; flex-wrap: wrap; }
    .row-actions { display: flex; gap: 6px; flex-wrap: wrap; opacity: 0; transition: var(--transition); }
    tbody tr:hover .row-actions { opacity: 1; }
    .pts { font-variant-numeric: tabular-nums; font-weight: 700; font-size: 18px; color: var(--accent-yellow); }
    .pts.negative { color: var(--accent-red); }

    /* * ==============================================
     * MODALS & OVERLAYS
     * ==============================================
     */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(26, 27, 38, .8);
      backdrop-filter: blur(5px);
      display: flex; align-items: center; justify-content: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    body.light-mode .modal-backdrop { background: rgba(255, 255, 255, .8); }
    .modal-backdrop.show { opacity: 1; pointer-events: auto; }
    .modal {
      width: min(720px, 96vw);
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--bg-light);
      box-shadow: var(--shadow);
      transform: scale(.95);
      transition: transform .3s ease;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }
    .modal-backdrop.show .modal { transform: scale(1); }
    .modal header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--bg-light); }
    .modal .body { padding: 24px; display: grid; gap: 16px; overflow-y: auto; }

    .power-card {
      background: var(--bg-med);
      border: 1px solid var(--bg-light);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex; flex-direction: column; gap: 10px;
      transition: var(--transition);
      cursor: pointer;
    }
    .power-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,.3); border-color: var(--accent-primary); }
    .power-card .top { display: flex; align-items: center; justify-content: space-between; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
    
    .hidden { display: none !important; }

    .save-status {
      position: fixed; bottom: 24px; right: 24px;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      background: var(--accent-green);
      color: var(--bg-dark);
      font-weight: 600;
      font-size: 14px;
      opacity: 0;
      transform: translateY(10px);
      transition: all .3s ease;
      z-index: 100;
    }
    body.light-mode .save-status { color: #fff; }
    .save-status.show { opacity: 1; transform: translateY(0); }
    
    /* Dropdown */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { position: absolute; right: 0; top: calc(100% + 8px); background: var(--panel); border: 1px solid var(--bg-light); border-radius: var(--radius-md); padding: 8px; min-width: 180px; z-index: 10; box-shadow: var(--shadow); display: none; flex-direction: column; gap: 4px; }
    .dropdown-content.show { display: flex; }
    .dropdown-content button { width: 100%; justify-content: flex-start; padding: 8px 12px; }

    .manage-chip { display: flex; align-items: center; justify-content: space-between; gap: 8px; background: var(--bg-dark); padding: 6px 10px; border-radius: var(--radius-md);}
    .manage-chip .actions { display: flex; gap: 4px; }
    .manage-chip .actions button { background: none; border: none; cursor: pointer; padding: 4px; font-size: 16px; opacity: .7; transition: var(--transition); }
    .manage-chip .actions button:hover { opacity: 1; transform: scale(1.2); }
    .delete-btn { color: var(--accent-red); }
    .edit-btn { color: var(--accent-secondary); }

    /* Punishment Wheel */
    .wheel-container { position: relative; width: 100%; max-width: 280px; margin: 10px auto; display: grid; place-items: center; }
    #punishmentWheel, #largePunishmentWheel { width: 100%; height: auto; transition: transform 6s cubic-bezier(0.15, 0.8, 0.3, 1); filter: drop-shadow(0 5px 15px rgba(0,0,0,.4)); }
    .wheel-container::after {
      content: '‚ñº';
      font-size: 38px;
      color: var(--accent-red);
      position: absolute;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
      text-shadow: 0 3px 6px rgba(0,0,0,.5);
      z-index: 2;
    }
    
    .sidebar-bottom-group {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }
    .sidebar-footer {
      padding-top: 16px;
      border-top: 1px solid var(--bg-light);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="header panel">
    <div class="title" data-lang-key="title">‚ú® Magic Class</div>
    <div style="display:flex; align-items:center; gap: 8px;">
      <button class="btn small ghost" id="btnLangToggle" title="Switch Language">RU</button>
      <button class="btn small ghost" id="btnThemeToggle" data-lang-key-title="toggleThemeTitle" title="Toggle Theme"></button>
      <button class="btn small primary" id="btnSave" data-lang-key="saveNow">üíæ Save Now</button>
      <div class="dropdown">
        <button class="btn small ghost" id="btnAdminDropdown" data-lang-key="admin">‚öôÔ∏è Admin</button>
        <div class="dropdown-content" id="adminDropdown">
          <button class="btn small warning" id="btnReset" data-lang-key="resetApp">Reset App</button>
          <button class="btn small ghost" id="btnExport" data-lang-key="backup">Backup</button>
          <button class="btn small ghost" id="btnImportJson" data-lang-key="restore">Restore</button>
        </div>
      </div>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar panel">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
        <div style="font-weight:700; font-size: 18px;" data-lang-key="yourClasses">Your Classes</div>
        <button class="btn small primary" id="btnAddClass" data-lang-key="newClass">+ New Class</button>
      </div>
      
      <div class="class-list" id="classList"></div>

      <div class="sidebar-bottom-group">
        <div class="card">
          <h3 data-lang-key="importStudents">Import Students</h3>
          <div class="body">
            <small class="muted" data-lang-key="importSubtext">Paste names (one per line). Duplicates are ignored.</small>
            <textarea id="namesInput" data-lang-key="importPlaceholder" data-lang-attr="placeholder" placeholder="Jon Snow&#10;Daenerys Targaryen&#10;Tyrion Lannister&#10;‚Ä¶"></textarea>
            <button class="btn" id="btnImportNames" style="width: 100%;" data-lang-key="addToClass">Add to Class</button>
          </div>
        </div>

        <div class="sidebar-footer">
            <button class="btn small ghost icon" id="btnTogglePowers" data-lang-key-title="managePowersTitle" title="Manage Superpowers">üîÆ</button>
            <button class="btn small ghost icon" id="btnToggleDares" data-lang-key-title="manageDaresTitle" title="Manage Dares">üé°</button>
            <button class="btn small ghost icon" id="btnToggleActions" data-lang-key-title="manageActionsTitle" title="Manage Quick Actions">‚ö°Ô∏è</button>
        </div>
      </div>
    </aside>

    <section class="content">
      <div class="cards">
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; padding: 16px 20px; border-bottom: 1px solid rgba(187, 154, 247, .1);">
            <div class="chip" id="activeClassChip">No class selected</div>
            <div>
              <button class="btn small ghost" id="btnRenameClass" data-lang-key="rename">Rename</button>
              <button class="btn small warning" id="btnDeleteClass" data-lang-key="delete">Delete</button>
            </div>
          </div>
          <div class="body" style="padding: 0;">
             <div style="padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <button class="btn small" id="btnAddStudent" data-lang-key="addStudent">+ Add Student</button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn small" id="btnGiveAll" data-lang-key="giveAll">+1 All</button>
                    <button class="btn small primary" id="btnOpenShop" data-lang-key="openShop">üõí Open Shop</button>
                </div>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th style="width:38%" data-lang-key="studentHeader">Student</th>
                    <th style="width:12%" data-lang-key="pointsHeader">EDcoins</th>
                    <th data-lang-key="powersHeader">Powers</th>
                    <th style="width:32%" data-lang-key="actionsHeader">Actions</th>
                  </tr>
                </thead>
                <tbody id="studentsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="card" id="quickActionsCard">
            <h3 data-lang-key="quickActions">Quick Actions</h3>
            <div class="body">
              <small class="muted" data-lang-key="quickActionsSubtext">Select a student, then apply points.</small>
              <div id="quickActionsContainer" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
              <hr class="divider">
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="customDelta" type="number" data-lang-key="custom" data-lang-attr="placeholder" placeholder="Custom" style="flex: 1;">
                <button class="btn" id="btnApplyCustom" data-lang-key="apply">Apply</button>
              </div>
              
              <hr class="divider" style="margin-top: 16px;">
              <div style="display:flex; justify-content:center; align-items:center; position:relative;">
                  <h4 style="margin: 0 0 10px 0;" data-lang-key="punishmentWheel">Punishment Wheel</h4>
                  <button id="btnExpandWheel" class="btn small ghost icon" style="position:absolute; right:0; top:-5px;" data-lang-key-title="expandWheel" title="Expand Wheel">‚ÜóÔ∏è</button>
              </div>
              <div class="wheel-container">
                  <canvas id="punishmentWheel" width="500" height="500"></canvas>
              </div>
              <button class="btn primary" id="btnSpinWheel" style="width:100%" data-lang-key="spinWheel">Spin the Wheel</button>
            </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer muted" style="padding:12px 24px; font-size:12px; text-align:center;" data-lang-key="footer">
    Made by TeacherJon
  </div>

  <div class="modal-backdrop" id="shopModal">
    <div class="modal">
      <header>
        <div style="font-weight:700; font-size: 18px;" data-lang-key="shopTitle">üõí Superpowers Shop</div>
        <button class="btn icon ghost" data-close-modal aria-label="Close">‚úñ</button>
      </header>
      <div class="body">
        <div class="muted" data-lang-key="shopSubtext">Select a student first, then choose a superpower to purchase.</div>
        <div id="shopGrid" class="grid"></div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="manageModal">
    <div class="modal">
      <header>
        <div id="manageModalTitle" style="font-weight:700; font-size: 18px;">Manage</div>
        <button class="btn icon ghost" data-close-modal aria-label="Close">‚úñ</button>
      </header>
      <div class="body" id="manageModalBody"></div>
    </div>
  </div>

    <div class="modal-backdrop" id="wheelModal">
      <div class="modal" style="width: min(600px, 90vw); height: min(580px, 90vh);">
        <header>
          <div id="wheelModalTitle" style="font-weight:700; font-size: 18px;" data-lang-key="punishmentWheel">Punishment Wheel</div>
          <button class="btn icon ghost" data-close-modal aria-label="Close">‚úñ</button>
        </header>
        <div class="body" style="display:flex; flex-direction:column; align-items:center; justify-content:space-around; gap:20px;">
          <div class="wheel-container" style="max-width: 380px;">
              <canvas id="largePunishmentWheel" width="500" height="500"></canvas>
          </div>
          <button class="btn primary" id="btnSpinLargeWheel" style="width:90%; padding: 14px 0; font-size: 18px;" data-lang-key="spinWheel">Spin the Wheel</button>
        </div>
      </div>
    </div>

  <div class="modal-backdrop" id="confirmModal">
    <div class="modal" style="max-width: 420px;">
      <header><div id="confirmTitle" style="font-weight:700">Confirm Action</div></header>
      <div class="body">
        <p id="confirmMessage">Are you sure?</p>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
          <button class="btn ghost" id="confirmCancel" data-lang-key="cancel">Cancel</button>
          <button class="btn primary" id="confirmOk" data-lang-key="confirm">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="promptModal">
      <div class="modal" style="max-width: 420px;">
          <header><div id="promptTitle" style="font-weight:700">Enter Value</div></header>
          <div class="body">
              <p id="promptMessage"></p>
              <input type="text" id="promptInput">
              <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                  <button class="btn ghost" id="promptCancel" data-lang-key="cancel">Cancel</button>
                  <button class="btn primary" id="promptOk">OK</button>
              </div>
          </div>
      </div>
  </div>
  
  <div class="hidden">
      <div id="managePowersTemplate">
          <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 8px; align-items: center;">
            <input type="text" id="powerEmoji" placeholder="üéµ" style="width: 50px; text-align: center;">
            <input type="text" id="powerName" data-lang-key="powerNamePlaceholder" data-lang-attr="placeholder" placeholder="Summon Music">
            <input id="powerCost" type="number" min="1" placeholder="20" style="width: 70px;">
          </div>
          <button class="btn primary" id="btnAddPower" style="width: 100%;" data-lang-key="addToShop">Add to Shop</button>
          <hr class="divider">
          <div id="powerChips" style="display: flex; flex-direction: column; gap: 8px; max-height: 40vh; overflow-y: auto; padding-right: 5px;"></div>
      </div>
      <div id="manageDaresTemplate">
          <input type="text" id="dareText" data-lang-key="darePlaceholder" data-lang-attr="placeholder" placeholder="Sing a song...">
          <button class="btn primary" id="btnAddDare" style="width: 100%;" data-lang-key="addDare">Add Dare</button>
          <hr class="divider">
          <div id="daresList" style="display: flex; flex-direction: column; gap: 8px; max-height: 40vh; overflow-y: auto; padding-right: 5px;"></div>
      </div>
      <div id="manageActionsTemplate">
          <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;">
            <input type="text" id="actionLabel" data-lang-key="actionLabelPlaceholder" data-lang-attr="placeholder" placeholder="Creativity">
            <input id="actionDelta" type="number" placeholder="+5" style="width: 70px;">
          </div>
          <button class="btn primary" id="btnAddAction" style="width: 100%;" data-lang-key="addAction">Add Action</button>
          <hr class="divider">
          <div id="actionsList" style="display: flex; flex-direction: column; gap: 8px; max-height: 40vh; overflow-y: auto; padding-right: 5px;"></div>
      </div>
  </div>


  <div class="save-status" id="saveStatus"></div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  
  // ==============================================
  //      STATE & DATABASE CONFIG
  // ==============================================
  const DB_NAME = 'MagicITClassDB_v3';
  const DB_VERSION = 1;
  const STORE_NAME = 'appState';
  
  const defaultPowers = [
    { id: uid(), emoji:'‚ù§Ô∏è', name:'Extra Life(gets a second chance if they answer wrong.)', cost:15 },
    { id: uid(), emoji:'‚è≥', name:'Time Turner(cancel their own mistake.)', cost:20 },
    { id: uid(), emoji:'üòé', name:"Agent(Get Tips from Teacher)", cost:25 },
    { id: uid(), emoji:'üéµ', name:'DJ Mode (chooses song for break)', cost:30 },
    { id: uid(), emoji:'‚ùÑÔ∏è', name:"Time Freeze (5 min rest time for everyone)", cost:35 },
    { id: uid(), emoji:'ü™ë', name:"Teleport(Choose Seat)", cost:40 },
    { id: uid(), emoji:'üëª', name:'Invisibility(skip penalty once)', cost:45 },
    { id: uid(), emoji:'ü¶∏', name:"Saver Hero (No Homework)", cost:50 },
    { id: uid(), emoji:'üë®‚Äçüíª', name:"Hacker (Can Use Internet)", cost:55 },
    { id: uid(), emoji:'üèπ', name:'Robin Hood (Can give his coins to others)', cost:75 },
    { id: uid(), emoji:'üí∞', name:'Get x2 coins from now on)', cost:75 },
    { id: uid(), emoji:'7Ô∏è‚É£‚öΩ', name:"Ronaldo (Put a SUIIIIIII, every time he answers correct)", cost:80 },
    { id: uid(), emoji:'üîüüëë', name:"Messi (Gain 10 coins every match )", cost: 200 },
  ]; 
  
  const defaultDares = [
      { id: uid(), text: 'Sing a Song' },
      { id: uid(), text: 'Dance lezginka' },
      { id: uid(), text: '50 squats' },
      { id: uid(), text: 'No Talking-45min' },
      { id: uid(), text: '10X3 pushups' },
      { id: uid(), text: 'Easy Pass!' },
      { id: uid(), text: 'Staying-45min' },
      { id: uid(), text: 'Next lesson first' },
      { id: uid(), text: 'Delete Powers' },
      { id: uid(), text: 'Loose all coins' }
  ];

  const defaultQuickActions = [
      { id: uid(), label: 'Creativity', delta: 5 },
      { id: uid(), label: 'On Task', delta: 2 },
      { id: uid(), label: 'Off Task', delta: -1 },
      { id: uid(), label: 'Cussing', delta: -5 }
  ];

  let state = {
    classes: [],
    powers: defaultPowers,
    dares: defaultDares,
    quickActions: defaultQuickActions,
    ui: { activeClassId: null, selectedStudentId: null, language: 'en' },
  };

  let renderRequest = null;
  let saveTimeout = null;
  let wheelSpinning = false;
  
  // ==============================================
  //      TRANSLATIONS
  // ==============================================
  const translations = {
    en: {
        title: "‚ú® Magic Class",
        toggleThemeLight: "‚òÄÔ∏è Light",
        toggleThemeDark: "üåô Dark",
        toggleThemeTitle: "Toggle Theme",
        saveNow: "üíæ Save Now",
        admin: "‚öôÔ∏è Admin",
        resetApp: "Reset App",
        backup: "Backup",
        restore: "Restore",
        yourClasses: "Your Classes",
        newClass: "+ New Class",
        importStudents: "Import Students",
        importSubtext: "Paste names (one per line). Duplicates are ignored.",
        importPlaceholder: "Ali Aliev\nVali Valiev\nBobojon Boboev\nAziza Azizova",
        addToClass: "Add to Class",
        managePowersTitle: "Manage Superpowers",
        manageDaresTitle: "Manage Dares",
        manageActionsTitle: "Manage Quick Actions",
        rename: "Rename",
        delete: "Delete",
        addStudent: "+ Add Student",
        giveAll: "+1 All",
        openShop: "üõí Open Shop",
        studentHeader: "Student",
        pointsHeader: "EDcoins",
        powersHeader: "Powers",
        actionsHeader: "Actions",
        quickActions: "Quick Actions",
        quickActionsSubtext: "Select a student, then apply EDcoins.",
        custom: "Custom",
        apply: "Apply",
        punishmentWheel: "Punishment Wheel",
        expandWheel: "Expand Wheel",
        spinWheel: "Spin the Wheel",
        spinning: "Spinning...",
        footer: "Made by TeacherJon",
        shopTitle: "üõí Superpowers Shop",
        shopSubtext: "Select a student first, then choose a superpower to purchase.",
        cancel: "Cancel",
        confirm: "Confirm",
        powerNamePlaceholder: "Summon Music",
        addToShop: "Add to Shop",
        darePlaceholder: "Sing a song...",
        addDare: "Add Dare",
        actionLabelPlaceholder: "Creativity",
        addAction: "Add Action",
        noClassSelected: "No class selected",
        students: "students",
        noStudents: "Create a class and add students to begin!",
        addDaresToWheel: "Add dares to the wheel!",
        wheelHasSpoken: "The Wheel has Spoken!",
        chosenDareIs: "Fate has decided for you: ",
    },
    ru: {
        title: "‚ú® Magic Class",
        toggleThemeLight: "‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è",
        toggleThemeDark: "üåô –¢—ë–º–Ω–∞—è",
        toggleThemeTitle: "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É",
        saveNow: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
        admin: "‚öôÔ∏è –ê–¥–º–∏–Ω",
        resetApp: "–°–±—Ä–æ—Å–∏—Ç—å",
        backup: "–†–µ–∑. –∫–æ–ø–∏—è",
        restore: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
        yourClasses: "–í–∞—à–∏ –∫–ª–∞—Å—Å—ã",
        newClass: "+ –ù–æ–≤—ã–π –∫–ª–∞—Å—Å",
        importStudents: "–ò–º–ø–æ—Ä—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤",
        importSubtext: "–í—Å—Ç–∞–≤—å—Ç–µ –∏–º–µ–Ω–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É). –î—É–±–ª–∏–∫–∞—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.",
        importPlaceholder: "–ê–ª–∏ –ê–ª–∏–µ–≤\n–í–∞–ª–∏ –í–∞–ª–∏–µ–≤\n–ë–æ–±–æ –ë–æ–±–æ–µ–≤\n–ê–∑–∏–∑–∞ –ê–∑–∏–∑–æ–≤–∞",
        addToClass: "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Å",
        managePowersTitle: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É–ø–µ—Ä—Å–∏–ª–∞–º–∏",
        manageDaresTitle: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏",
        manageActionsTitle: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ã—Å—Ç—Ä—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏",
        rename: "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å",
        delete: "–£–¥–∞–ª–∏—Ç—å",
        addStudent: "+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞",
        giveAll: "+1 –í—Å–µ–º",
        openShop: "üõí –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω",
        studentHeader: "–°—Ç—É–¥–µ–Ω—Ç",
        pointsHeader: "EDcoins",
        powersHeader: "–°—É–ø–µ—Ä—Å–∏–ª—ã",
        actionsHeader: "–î–µ–π—Å—Ç–≤–∏—è",
        quickActions: "–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è",
        quickActionsSubtext: "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞, –∑–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç–µ EDcoins.",
        custom: "–î—Ä—É–≥–æ–µ",
        apply: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å",
        punishmentWheel: "–ö–æ–ª–µ—Å–æ –Ω–∞–∫–∞–∑–∞–Ω–∏–π",
        expandWheel: "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–ª–µ—Å–æ",
        spinWheel: "–ö—Ä—É—Ç–∏—Ç—å –∫–æ–ª–µ—Å–æ",
        spinning: "–í—Ä–∞—â–µ–Ω–∏–µ...",
        footer: "–°–¥–µ–ª–∞–Ω–æ TeacherJon",
        shopTitle: "üõí –ú–∞–≥–∞–∑–∏–Ω —Å—É–ø–µ—Ä—Å–∏–ª",
        shopSubtext: "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É–ø–µ—Ä—Å–∏–ª—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏.",
        cancel: "–û—Ç–º–µ–Ω–∞",
        confirm: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
        powerNamePlaceholder: "–í—ã–∑–≤–∞—Ç—å –º—É–∑—ã–∫—É",
        addToShop: "–î–æ–±–∞–≤–∏—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω",
        darePlaceholder: "–°–ø–µ—Ç—å –ø–µ—Å–Ω—é...",
        addDare: "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ",
        actionLabelPlaceholder: "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å",
        addAction: "–î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ",
        noClassSelected: "–ö–ª–∞—Å—Å –Ω–µ –≤—ã–±—Ä–∞–Ω",
        students: "—Å—Ç—É–¥–µ–Ω—Ç–æ–≤",
        noStudents: "–°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∞—Å—Å –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!",
        addDaresToWheel: "–î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –∫–æ–ª–µ—Å–æ!",
        wheelHasSpoken: "–ö–æ–ª–µ—Å–æ —Å–∫–∞–∑–∞–ª–æ —Å–≤–æ—ë —Å–ª–æ–≤–æ!",
        chosenDareIs: "–°—É–¥—å–±–∞ –≤—ã–±—Ä–∞–ª–∞ –¥–ª—è –≤–∞—Å: ",
    }
  };

  // ==============================================
  //      DATABASE & STATE MANAGEMENT
  // ==============================================
  const DB = {
    db: null,
    async open() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => reject(req.error);
        req.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
        req.onsuccess = (event) => { this.db = event.target.result; resolve(this.db); };
      });
    },
    async get(key) {
      const db = this.db || await this.open();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).get(key);
        tx.onsuccess = () => resolve(tx.result);
        tx.onerror = () => reject(tx.error);
      });
    },
    async put(key, value) {
      const db = this.db || await this.open();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).put({ id: key, data: value });
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }
  };

  function uid(){ return 'id-' + Math.random().toString(36).slice(2, 11); }

  async function save() {
    try {
      await DB.put('state', state);
      showSaveStatus('Saved!');
    } catch (e) {
      console.error('Failed to save:', e);
      showSaveStatus('Save failed!');
    }
  }

  function debouncedSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(save, 800);
  }

  function showSaveStatus(msg) {
    const el = $('#saveStatus');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
  }

  // ==============================================
  //      CUSTOM MODALS & UI
  // ==============================================
  function showConfirm(title, message) {
      return new Promise((resolve) => {
          $('#confirmTitle').textContent = title;
          $('#confirmMessage').textContent = message;
          const modal = $('#confirmModal');
          modal.classList.add('show');

          const okBtn = $('#confirmOk');
          const cancelBtn = $('#confirmCancel');

          const handler = (result) => {
              modal.classList.remove('show');
              okBtn.removeEventListener('click', okHandler);
              cancelBtn.removeEventListener('click', cancelHandler);
              resolve(result);
          };
          const okHandler = () => handler(true);
          const cancelHandler = () => handler(false);

          okBtn.addEventListener('click', okHandler, { once: true });
          cancelBtn.addEventListener('click', cancelHandler, { once: true });
      });
  }

  function showPrompt(title, message, defaultValue = '') {
      return new Promise((resolve) => {
          $('#promptTitle').textContent = title;
          $('#promptMessage').textContent = message;
          const input = $('#promptInput');
          input.value = defaultValue;
          const modal = $('#promptModal');
          modal.classList.add('show');
          input.focus();
          input.select();

          const okBtn = $('#promptOk');
          const cancelBtn = $('#promptCancel');

          const handler = (value) => {
              modal.classList.remove('show');
              okBtn.removeEventListener('click', okHandler);
              cancelBtn.removeEventListener('click', cancelHandler);
              input.removeEventListener('keydown', enterHandler);
              resolve(value);
          };
          const okHandler = () => handler(input.value);
          const cancelHandler = () => handler(null);
          const enterHandler = (e) => { if (e.key === 'Enter') okHandler(); };

          okBtn.addEventListener('click', okHandler, { once: true });
          cancelBtn.addEventListener('click', cancelHandler, { once: true });
          input.addEventListener('keydown', enterHandler);
      });
  }
  
    function applyLanguage(lang) {
        state.ui.language = lang;
        localStorage.setItem('magicClassLanguage', lang);
        const t = translations[lang];

        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if (t[key]) {
                if (el.dataset.langAttr === 'placeholder') {
                    el.placeholder = t[key];
                } else {
                    el.innerHTML = t[key];
                }
            }
        });
        
        document.querySelectorAll('[data-lang-key-title]').forEach(el => {
            const key = el.dataset.langKeyTitle;
             if (t[key]) el.title = t[key];
        });

        const isLight = document.body.classList.contains('light-mode');
        $('#btnThemeToggle').innerHTML = isLight ? t.toggleThemeDark : t.toggleThemeLight;
        
        $('#btnLangToggle').textContent = lang === 'en' ? 'RU' : 'EN';
        
        updateActiveClassChip();
        renderStudents();
        drawPunishmentWheel();
        if ($('#wheelModal').classList.contains('show')) {
            drawPunishmentWheel('largePunishmentWheel');
        }
    }

  function applyTheme(theme) {
      const toggleBtn = $('#btnThemeToggle');
      const lang = state.ui.language;
      const t = translations[lang];

      if (theme === 'light') {
          document.body.classList.add('light-mode');
          if (toggleBtn) toggleBtn.innerHTML = t.toggleThemeDark;
          localStorage.setItem('magicClassTheme', 'light');
      } else {
          document.body.classList.remove('light-mode');
          if (toggleBtn) toggleBtn.innerHTML = t.toggleThemeLight;
          localStorage.setItem('magicClassTheme', 'dark');
      }
      drawPunishmentWheel();
      if ($('#wheelModal').classList.contains('show')) {
          drawPunishmentWheel('largePunishmentWheel');
      }
  }

  // ==============================================
  //      RENDERING LOGIC
  // ==============================================
  function scheduleRender() {
    if (!renderRequest) {
      renderRequest = requestAnimationFrame(() => {
        renderAll();
        renderRequest = null;
      });
    }
  }

  function renderAll(){
    renderClasses();
    renderStudents();
    updateActiveClassChip();
    buildShop();
    renderQuickActionButtons();
    drawPunishmentWheel();
  }
  
  function renderClasses(){
    const list = $('#classList');
    list.innerHTML = state.classes.map(cls => `
      <div class="class-item ${cls.id === state.ui.activeClassId ? 'active' : ''}" data-id="${cls.id}">
        <div style="display:flex;flex-direction:column">
          <strong>${escapeHtml(cls.name)}</strong>
          <small class="muted">${cls.students.length} ${translations[state.ui.language].students}</small>
        </div>
      </div>`).join('');
  }

  function renderManagePowers(){
    $('#powerChips').innerHTML = state.powers.map(p => `
      <div class="manage-chip">
        <span>${p.emoji} ${escapeHtml(p.name)} (${p.cost})</span>
        <div class="actions">
          <button class="delete-btn" data-id="${p.id}" title="Remove">üóëÔ∏è</button>
        </div>
      </div>`).join('');
  }
  
  function renderManageDares(){
    $('#daresList').innerHTML = state.dares.map(d => `
      <div class="manage-chip">
        <span>${escapeHtml(d.text)}</span>
        <div class="actions">
          <button class="delete-btn" data-id="${d.id}" title="Remove">üóëÔ∏è</button>
        </div>
      </div>`).join('');
  }

  function renderManageActions(){
      $('#actionsList').innerHTML = state.quickActions.map(a => `
      <div class="manage-chip">
        <span>${escapeHtml(a.label)} (${a.delta > 0 ? '+' : ''}${a.delta})</span>
        <div class="actions">
          <button class="delete-btn" data-id="${a.id}" title="Remove">üóëÔ∏è</button>
        </div>
      </div>`).join('');
  }

  function renderStudents(){
    const body = $('#studentsBody');
    const cls = getActiveClass();
    const t = translations[state.ui.language];
    if (!cls || !cls.students.length) {
      body.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center; padding: 24px;">${t.noStudents}</td></tr>`;
      return;
    }
    const sortedStudents = [...cls.students].sort((a,b) => a.name.localeCompare(b.name));
    
    body.innerHTML = sortedStudents.map(stu => {
      const nameParts = stu.name.trim().split(' ');
      const initials = (nameParts.length > 1 ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : stu.name.trim()[0] || '?').toUpperCase();
      const points = stu.points || 0;
      return `
        <tr data-id="${stu.id}" style="${state.ui.selectedStudentId === stu.id ? 'background-color: rgba(122, 162, 247, .1);' : ''}">
          <td>
            <div class="name-cell">
              <div class="avatar">${initials}</div>
              <strong>${escapeHtml(stu.name)}</strong>
            </div>
          </td>
          <td class="pts ${points < 0 ? 'negative' : ''}">${points}</td>
          <td>
            <div class="powers">${stu.powers.map(p => renderPowerIcon(p)).join('') || '<span class="muted">‚Äî</span>'}</div>
          </td>
          <td>
            <div class="row-actions">
              <button class="btn small" data-act="add1" title="+1 EDcoin">+1</button>
              <button class="btn small" data-act="add5" title="+5 EDcoins">+5</button>
              <button class="btn small warning" data-act="sub2" title="-2 EDcoins">-2</button>
              <button class="btn small primary" data-act="shop" title="Open Shop">üõí</button>
              <button class="btn small ghost" data-act="rename" title="Rename">‚úé</button>
              <button class="btn small ghost" data-act="remove" title="Remove">üóëÔ∏è</button>
            </div>
          </td>
        </tr>`;
    }).join('');
  }

  function renderPowerIcon(powerInstance){
    const p = state.powers.find(x => x.id === powerInstance.id) || { emoji:'‚ùî', name:'Unknown' };
    const title = `Remove "${p.name}"? (Used on ${new Date(powerInstance.ts).toLocaleDateString()})`;
    return `<span class="chip power-icon" title="${title}" data-act="remove-power" data-ts="${powerInstance.ts}">${p.emoji}</span>`;
  }

  function buildShop(){
    $('#shopGrid').innerHTML = state.powers.map(p => `
      <div class="power-card" data-id="${p.id}">
        <div class="top">
          <div style="font-size:28px">${p.emoji}</div>
          <div class="chip">${p.cost} EDcoins</div>
        </div>
        <div style="font-weight:600">${escapeHtml(p.name)}</div>
      </div>`).join('');
  }
  
  function renderQuickActionButtons() {
      const container = $('#quickActionsContainer');
      container.innerHTML = state.quickActions.map(action => {
          const isNegative = action.delta < 0;
          const sign = action.delta > 0 ? '+' : '';
          return `<button class="btn small ${isNegative ? 'warning' : ''}" data-delta="${action.delta}" title="${sign}${action.delta} EDcoins for ${action.label}">${sign}${action.delta} ${action.label}</button>`;
      }).join('');
  }

  function updateActiveClassChip(){
    const cls = getActiveClass();
    const t = translations[state.ui.language];
    $('#activeClassChip').textContent = cls ? `${cls.name} ‚Äî ${cls.students.length} ${t.students}` : t.noClassSelected;
  }

  // ==============================================
  //      PUNISHMENT WHEEL LOGIC
  // ==============================================
  function drawPunishmentWheel(canvasId = 'punishmentWheel') {
      const canvas = $(`#${canvasId}`);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const [width, height] = [canvas.width, canvas.height];
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = width / 2 - 20;
      const t = translations[state.ui.language];
      
      const dares = state.dares;
      if (!dares.length) { 
          ctx.clearRect(0, 0, width, height);
          ctx.textAlign = 'center';
          ctx.fillStyle = document.body.classList.contains('light-mode') ? '#050505' : '#c0caf5';
          ctx.font = '24px Poppins';
          ctx.fillText(t.addDaresToWheel, centerX, centerY);
          return; 
      }
      const numSegments = dares.length;
      const angleStep = (2 * Math.PI) / numSegments;
      
      const colors = ['#bb9af7', '#7aa2f7', '#9ece6a', '#e0af68', '#f7768e', '#c0caf5'];
      const isLight = document.body.classList.contains('light-mode');

      ctx.clearRect(0, 0, width, height);
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.translate(-centerX, -centerY);

      for (let i = 0; i < numSegments; i++) {
          const startAngle = i * angleStep;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, startAngle + angleStep);
          ctx.closePath();
          ctx.fillStyle = colors[i % colors.length];
          ctx.fill();
      }
      
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = isLight ? 'rgba(0,0,0,0.1)' : 'rgba(0,0,0,0.3)';
      ctx.lineWidth = 8;
      ctx.stroke();

      ctx.font = '22px Poppins';
      for (let i = 0; i < numSegments; i++) {
          ctx.save();
          const textAngle = (i * angleStep) + (angleStep / 2);
          ctx.translate(centerX, centerY);
          ctx.rotate(textAngle);
          ctx.textAlign = 'center';
          ctx.fillStyle = isLight ? 'rgba(0,0,0,0.6)' : '#1a1b26';
          ctx.fillText(dares[i].text, radius * 0.55, 0, radius * 0.45);
          ctx.restore();
      }
      ctx.restore();
  }
  
    function spinWheel(canvasId = 'punishmentWheel', buttonId = 'btnSpinWheel') {
      if (wheelSpinning || !state.dares.length) return;
      wheelSpinning = true;
      const t = translations[state.ui.language];
      const spinBtn = $(`#${buttonId}`);
      spinBtn.disabled = true;
      spinBtn.textContent = t.spinning;
      const wheel = $(`#${canvasId}`);
      const numSegments = state.dares.length;
      const segmentAngle = 360 / numSegments;
      // Use a fixed starting offset so the arrow points correctly
      // The arrow is at the top (-90 degrees), and we want the *center* of the segment to align.
      const arrowOffsetDegrees = -90; 
      const randomSegment = Math.floor(Math.random() * numSegments);
      const winningDare = state.dares[randomSegment];
      const targetAngleForSegmentCenter = arrowOffsetDegrees; // -90 degrees (pointing up)
      // The angle for the start of the segment (canvas angle, counter-clockwise from right)
      const startAngleCanvas = (randomSegment * segmentAngle); 
      const extraRotations = 5; // Number of full spins
      const baseRotation = -(randomSegment * segmentAngle) - 90 - (segmentAngle / 2);
      const totalRotation = (extraRotations * 360) + baseRotation;

      wheel.style.transition = 'none';
      wheel.style.transform = `rotate(0deg)`;
      // Force reflow
      wheel.getBoundingClientRect(); 
      // Apply smooth spin transition
      wheel.style.transition = 'transform 6s cubic-bezier(0.15, 0.8, 0.3, 1)'; // Smooth easing
      wheel.style.transform = `rotate(${totalRotation}deg)`;

      setTimeout(() => {
          // Show the result for the correct dare
          showConfirm(t.wheelHasSpoken, `${t.chosenDareIs} "${winningDare.text}"`);
          wheelSpinning = false;
          spinBtn.disabled = false;
          spinBtn.textContent = t.spinWheel;
      }, 6100); // Slightly longer than transition duration to ensure it finishes
  }

  // ==============================================
  //      ACTIONS & HELPERS
  // ==============================================
  function getActiveClass(){ return state.classes.find(c => c.id === state.ui.activeClassId) || null; }
  function getActiveStudent(){ const cls = getActiveClass(); return cls?.students.find(s => s.id === state.ui.selectedStudentId) || null; }
  function escapeHtml(str){
    return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
  }

  // ==============================================
  //      EVENT HANDLERS
  // ==============================================
  async function handleAddClass() {
    const name = await showPrompt('Create New Class', 'Enter class name (e.g., 7A):');
    if (!name || !name.trim()) return;
    const cls = { id: uid(), name: name.trim(), students: [] };
    state.classes.push(cls);
    state.ui.activeClassId = cls.id;
    debouncedSave();
    scheduleRender();
  }

  async function handleDeleteClass(){
    const cls = getActiveClass(); if (!cls) return;
    const confirmed = await showConfirm('Delete Class', `Are you sure you want to delete "${cls.name}"? This cannot be undone.`);
    if (!confirmed) return;
    state.classes = state.classes.filter(c => c.id !== cls.id);
    state.ui.activeClassId = state.classes[0]?.id || null;
    state.ui.selectedStudentId = null;
    debouncedSave();
    scheduleRender();
  }

  async function handleRenameClass(){
    const cls = getActiveClass(); if (!cls) return;
    const name = await showPrompt('Rename Class', 'Enter new name:', cls.name);
    if (!name || !name.trim()) return;
    cls.name = name.trim();
    debouncedSave();
    scheduleRender();
  }
  
  async function handleAddStudent() {
      const cls = getActiveClass();
      if (!cls) { showConfirm('No Class Selected', 'Please select or create a class first.'); return; }
      const name = await showPrompt('Add Student', 'Enter student name:');
      const clean = (name || '').trim();
      if (!clean) return;
      if (cls.students.some(s => s.name.toLowerCase() === clean.toLowerCase())) {
          showConfirm('Duplicate Name', `A student named "${clean}" already exists in this class.`); return;
      }
      cls.students.push({ id: uid(), name: clean, points: 0, powers: [] });
      debouncedSave();
      scheduleRender();
  }
  
  async function handleRemovePowerFromStudent(student, powerTimestamp) {
      const powerInstance = student.powers.find(p => p.ts === powerTimestamp);
      if (!powerInstance) return;
      const powerInfo = state.powers.find(p => p.id === powerInstance.id) || { name: 'Unknown Power' };
      const confirmed = await showConfirm('Remove Superpower', `Remove "${powerInfo.name}" from ${student.name}?`);
      if (!confirmed) return;
      student.powers = student.powers.filter(p => p.ts !== powerTimestamp);
      debouncedSave();
      scheduleRender();
  }
  
  function openManagementModal(type) {
      const modal = $('#manageModal');
      const title = $('#manageModalTitle');
      const body = $('#manageModalBody');
      const t = translations[state.ui.language];
      let template, renderFn;

      if (type === 'powers') {
          title.textContent = `üîÆ ${t.managePowersTitle}`;
          template = $('#managePowersTemplate');
          renderFn = renderManagePowers;
      } else if (type === 'dares') {
          title.textContent = `üé° ${t.manageDaresTitle}`;
          template = $('#manageDaresTemplate');
          renderFn = renderManageDares;
      } else {
          title.textContent = `‚ö°Ô∏è ${t.manageActionsTitle}`;
          template = $('#manageActionsTemplate');
          renderFn = renderManageActions;
      }
      
      body.innerHTML = template.innerHTML;
      applyLanguage(state.ui.language);
      renderFn();
      modal.classList.add('show');
  }
  
  // ==============================================
  //      INITIALIZATION & MAIN EVENT LISTENERS
  // ==============================================
  async function init() {
    try {
      await DB.open();
      const savedState = (await DB.get('state'))?.data;
      if (savedState) {
        state = { ...state, ...savedState };
        if (!state.dares) state.dares = defaultDares;
        if (!state.quickActions) state.quickActions = defaultQuickActions;
        if (!state.ui.language) state.ui.language = 'en';
      } else {
        await save();
      }
      
      const savedTheme = localStorage.getItem('magicClassTheme') || 'dark';
      const savedLang = localStorage.getItem('magicClassLanguage') || 'en';
      state.ui.language = savedLang;
      applyTheme(savedTheme);
      applyLanguage(savedLang);

      $('#btnThemeToggle').addEventListener('click', () => {
          const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
          applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
      });
      
      $('#btnLangToggle').addEventListener('click', () => {
          const newLang = state.ui.language === 'en' ? 'ru' : 'en';
          applyLanguage(newLang);
      });

      $('#btnAddClass').addEventListener('click', handleAddClass);
      $('#btnDeleteClass').addEventListener('click', handleDeleteClass);
      $('#btnRenameClass').addEventListener('click', handleRenameClass);
      $('#btnAddStudent').addEventListener('click', handleAddStudent);
      $('#btnGiveAll').addEventListener('click', () => {
          const cls = getActiveClass();
          if (cls) {
              cls.students.forEach(s => s.points = (s.points || 0) + 1);
              debouncedSave();
              scheduleRender();
          }
      });
      $('#btnOpenShop').addEventListener('click', () => $('#shopModal').classList.add('show'));
      $('#btnSpinWheel').addEventListener('click', () => spinWheel());
      $('#btnSpinLargeWheel').addEventListener('click', () => spinWheel('largePunishmentWheel', 'btnSpinLargeWheel'));
      
      $('#btnExpandWheel').addEventListener('click', () => {
          $('#wheelModal').classList.add('show');
          drawPunishmentWheel('largePunishmentWheel');
      });

      $('#btnImportNames').addEventListener('click', () => {
          const cls = getActiveClass(); if (!cls) return;
          const names = ($('#namesInput').value || '').trim().split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          if (!names.length) return;
          names.forEach(n => {
              if (!cls.students.some(s => s.name.toLowerCase() === n.toLowerCase())) {
                  cls.students.push({ id: uid(), name: n, points: 0, powers: [] });
              }
          });
          $('#namesInput').value = '';
          debouncedSave();
          scheduleRender();
      });
      $('#btnApplyCustom').addEventListener('click', () => {
          const delta = parseInt($('#customDelta').value, 10);
          const stu = getActiveStudent();
          if (!isNaN(delta) && stu) {
              stu.points = (stu.points || 0) + delta;
              $('#customDelta').value = '';
              debouncedSave();
              scheduleRender();
          } else if (!stu) {
             showConfirm('No Student Selected', 'Please click on a student row to select them first.');
          }
      });
      $('#quickActionsContainer').addEventListener('click', (e) => {
          const btn = e.target.closest('button[data-delta]');
          if (!btn) return;
          const delta = parseInt(btn.dataset.delta, 10);
          const stu = getActiveStudent();
          if (!isNaN(delta) && stu) {
              stu.points = (stu.points || 0) + delta;
              debouncedSave();
              scheduleRender();
          } else if (!stu) {
              showConfirm('No Student Selected', 'Please click on a student row to select them first.');
          }
      });
      $('#btnSave').addEventListener('click', () => { clearTimeout(saveTimeout); save(); });

      // --- Sidebar Footer & Modal Toggles ---
      $('#btnTogglePowers').addEventListener('click', () => openManagementModal('powers'));
      $('#btnToggleDares').addEventListener('click', () => openManagementModal('dares'));
      $('#btnToggleActions').addEventListener('click', () => openManagementModal('actions'));
      $$('[data-close-modal]').forEach(btn => btn.addEventListener('click', (e) => {
          e.target.closest('.modal-backdrop').classList.remove('show');
      }));
      
      // Admin Dropdown
      $('#btnAdminDropdown').addEventListener('click', (e) => { e.stopPropagation(); $('#adminDropdown').classList.toggle('show'); });
      document.addEventListener('click', () => $('#adminDropdown').classList.remove('show'));
     
     
      $('#btnReset').addEventListener('click', async () => {
    if (await showConfirm('Reset Everything?', 'This will erase all data. This cannot be undone.')) {
        state = {
            classes: [],
            powers: defaultPowers.map(p => ({ ...p })),
            dares: defaultDares.map(d => ({ ...d })),
            quickActions: defaultQuickActions.map(a => ({ ...a })),
            ui: { activeClassId: null, selectedStudentId: null, language: state.ui.language || 'en' } // Preserve language
        };
        debouncedSave();
        // Introduce a small delay before rendering to allow the UI to update/respond
        // This prevents the freeze perceived when closing the confirm modal.
        setTimeout(() => {
            scheduleRender();
        }, 10); // 10ms delay is usually enough
    }
});



      $('#btnExport').addEventListener('click', () => {
          const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `magic_class_backup_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(a.href);
      });
      $('#btnImportJson').addEventListener('click', () => {
          const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
          input.onchange = () => {
              const f = input.files[0]; if (!f) return;
              const r = new FileReader();
              r.onload = async () => {
                  try {
                      const obj = JSON.parse(r.result);
                      if (!obj || !obj.classes) throw new Error('Invalid format');
                      if (await showConfirm('Confirm Restore', 'This will overwrite your current data. Are you sure?')) {
                          state = { ...state, ...obj };
                          debouncedSave();
                          scheduleRender();
                      }
                  } catch (err) { showConfirm('Import Error', 'The selected file was not a valid backup file.'); }
              };
              r.readAsText(f);
          };
          input.click();
      });

      // ==============================================
      //      EVENT DELEGATION FOR DYNAMIC CONTENT
      // ==============================================
      $('#classList').addEventListener('click', (e) => {
          const classItem = e.target.closest('.class-item');
          if (classItem) {
              state.ui.activeClassId = classItem.dataset.id;
              state.ui.selectedStudentId = null;
              scheduleRender();
          }
      });

      $('#studentsBody').addEventListener('click', async (e) => {
          const row = e.target.closest('tr[data-id]');
          if (!row) return;
          const stuId = row.dataset.id;
          const cls = getActiveClass();
          const student = cls?.students.find(s => s.id === stuId);
          if (!student) return;

          const actionBtn = e.target.closest('button[data-act]');
          const powerIcon = e.target.closest('.power-icon[data-act="remove-power"]');

          if (actionBtn) {
              e.stopPropagation();
              const act = actionBtn.dataset.act;
              if (act === 'add1') student.points = (student.points || 0) + 1;
              else if (act === 'add5') student.points = (student.points || 0) + 5;
              else if (act === 'sub2') student.points = (student.points || 0) - 2;
              else if (act === 'shop') { state.ui.selectedStudentId = student.id; scheduleRender(); $('#shopModal').classList.add('show'); return; }
              else if (act === 'rename') { const name = await showPrompt('Rename Student', 'Enter new name:', student.name); if(name) student.name = name.trim(); }
              else if (act === 'remove') { if(await showConfirm('Remove Student', `Permanently remove ${student.name}?`)) cls.students = cls.students.filter(s => s.id !== stuId); }
              debouncedSave();
              scheduleRender();
          } else if (powerIcon) {
              const ts = parseInt(powerIcon.dataset.ts, 10);
              await handleRemovePowerFromStudent(student, ts);
          } else {
              state.ui.selectedStudentId = stuId;
              scheduleRender();
          }
      });
      
      $('#shopGrid').addEventListener('click', async (e) => {
          const card = e.target.closest('.power-card'); if (!card) return;
          const stu = getActiveStudent();
          if (!stu) { await showConfirm('No Student Selected', 'Select a student first.'); return; }
          const p = state.powers.find(x => x.id === card.dataset.id); if (!p) return;
          if ((stu.points || 0) < p.cost) { await showConfirm('Not Enough EDcoins', `${stu.name} needs ${p.cost} EDcoins, but only has ${stu.points}.`); return; }
          if (!await showConfirm('Confirm Purchase', `Buy "${p.name}" for ${p.cost} EDcoins for ${stu.name}?`)) return;
          stu.points -= p.cost;
          stu.powers.push({ id: p.id, ts: Date.now() });
          debouncedSave();
          scheduleRender();
          $('#shopModal').classList.remove('show');
      });
      
      // Management modal actions
      $('#manageModal').addEventListener('click', async (e) => {
        // Add buttons
        if(e.target.id === 'btnAddPower') {
            const emoji = ($('#powerEmoji').value.trim() || '‚ú®');
            const name = $('#powerName').value.trim();
            const cost = parseInt($('#powerCost').value, 10) || 10;
            if (!name) return;
            state.powers.push({ id: uid(), emoji, name, cost });
            $('#powerEmoji').value = ''; $('#powerName').value = ''; $('#powerCost').value = '';
            debouncedSave(); renderManagePowers(); buildShop();
        }
        if(e.target.id === 'btnAddDare') {
            const text = $('#dareText').value.trim(); if (!text) return;
            state.dares.push({ id: uid(), text });
            $('#dareText').value = '';
            debouncedSave(); renderManageDares(); drawPunishmentWheel();
        }
        if(e.target.id === 'btnAddAction') {
            const label = $('#actionLabel').value.trim();
            const delta = parseInt($('#actionDelta').value, 10);
            if (!label || isNaN(delta)) return;
            state.quickActions.push({ id: uid(), label, delta });
            $('#actionLabel').value = ''; $('#actionDelta').value = '';
            debouncedSave(); renderManageActions(); renderQuickActionButtons();
        }

        // Edit/Delete buttons
        const delBtn = e.target.closest('.delete-btn');
        const editBtn = e.target.closest('.edit-btn');
        if (delBtn) {
            const id = delBtn.dataset.id;
            let item, list, name, renderFn, afterFn;
            if ( (item = state.powers.find(i=>i.id===id)) ) { list = state.powers; name = item.name; renderFn = renderManagePowers; afterFn = buildShop; }
            else if ( (item = state.dares.find(i=>i.id===id)) ) { list = state.dares; name = item.text; renderFn = renderManageDares; afterFn = drawPunishmentWheel; }
            else if ( (item = state.quickActions.find(i=>i.id===id)) ) { list = state.quickActions; name = item.label; renderFn = renderManageActions; afterFn = renderQuickActionButtons; }
            
            if(item && await showConfirm('Confirm Deletion', `Delete "${name}"?`)) {
                const index = list.findIndex(i => i.id === id);
                if (index > -1) list.splice(index, 1);
                debouncedSave(); renderFn(); if(afterFn) afterFn();
            }
        }
        if (editBtn) { /* Edit logic would go here, reusing prompts */ }
      });

      scheduleRender();
    } catch (e) {
      console.error('Init failed:', e);
      document.body.innerHTML = 'Failed to load application. Please clear your browser data for this site and try again.';
    }
  }

  init();
})();
</script>
</body>
</html>