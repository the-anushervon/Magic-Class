<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Magic IT Class ‚Äî Points & Superpowers</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a1a;
      --panel: #11112a;
      --card: #1a1a3a;
      --text: #e0e6f0;
      --muted: #8a95b0;
      --accent: #7c4dff;
      --accent-2: #00d4ff;
      --success: #00f5d4;
      --danger: #ff5e7d;
      --gold: #ffb74d;
      --chip: #2a2a4a;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      --glow: 0 0 15px rgba(124, 77, 255, 0.6);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #0f0f2a 100%);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at center, rgba(124, 77, 255, 0.08) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }
    .app {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
      padding: 24px;
      max-width: 1400px;
      margin: auto;
    }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(124, 77, 255, 0.2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      background: rgba(17, 17, 42, 0.6);
      border-radius: var(--radius);
      border: 1px solid rgba(124, 77, 255, 0.3);
      box-shadow: var(--glow), var(--shadow);
    }
    .title {
      font-size: 24px;
      font-weight: 900;
      letter-spacing: 1px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-family: 'Inter', sans-serif;
    }
    .btn {
      border: none;
      background: rgba(124, 77, 255, 0.2);
      color: var(--text);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      font-weight: 600;
      border: 1px solid rgba(124, 77, 255, 0.3);
    }
    .btn:hover {
      background: rgba(124, 77, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3), var(--glow);
    }
    .btn:active { transform: translateY(0); }
    .btn.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      font-weight: 700;
    }
    .btn.primary:hover {
      filter: brightness(1.1) saturate(1.2);
      box-shadow: 0 8px 20px rgba(124, 77, 255, 0.4);
    }
    .btn.warning { background: var(--danger); }
    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(138, 149, 176, 0.3);
    }
    .btn.small { padding: 6px 10px; font-size: 13px; }
    .btn.icon { padding: 8px; width: 36px; }

    /* Sparkle effect */
    .sparkle {
      position: absolute;
      pointer-events: none;
      z-index: 100;
      width: 20px;
      height: 20px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%2300d4ff" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>');
      background-size: contain;
      animation: sparkle 1.2s ease-out forwards;
      opacity: 0;
    }
    @keyframes sparkle {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.5); opacity: 1; }
      100% { transform: translateY(-20px) scale(0.8); opacity: 0; }
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .class-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .class-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--card);
      border-radius: 12px;
      border: 1px solid rgba(138, 149, 176, 0.15);
      cursor: pointer;
      transition: var(--transition);
    }
    .class-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
      border-color: var(--accent-2);
    }
    .class-item.active {
      outline: 2px solid var(--accent-2);
      box-shadow: var(--glow);
    }
    .chip {
      background: var(--chip);
      border: 1px solid rgba(138, 149, 176, 0.2);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      color: var(--muted);
    }
    .card-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Table */
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border-radius: 0 0 12px 12px;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }
    thead th {
      text-align: left;
      padding: 10px 12px;
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tbody td {
      background: var(--card);
      padding: 12px;
      border: 1px solid rgba(138, 149, 176, 0.1);
    }
    tbody tr td:first-child {
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
    }
    tbody tr td:last-child {
      border-top-right-radius: 12px;
      border-bottom-right-radius: 12px;
    }

    /* Drag handle */
    .drag-handle {
      cursor: grab;
      opacity: 0.4;
      font-size: 16px;
    }
    .drag-handle:hover {
      opacity: 1;
      color: var(--accent-2);
    }

    /* Power removal */
    .power-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(0, 212, 255, 0.15);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 12px;
      margin-right: 4px;
    }
    .power-chip .remove-power {
      color: var(--danger);
      cursor: pointer;
      font-size: 14px;
      opacity: 0.6;
    }
    .power-chip .remove-power:hover {
      opacity: 1;
    }

    /* Confetti */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #ff0;
      pointer-events: none;
      z-index: 1000;
      opacity: 0.8;
      border-radius: 20%;
    }

    /* Animations */
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .pop {
      animation: pop 0.3s ease-out;
    }

    /* Modals */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal {
      width: min(720px, 90vw);
      background: var(--panel);
      border-radius: 20px;
      border: 1px solid rgba(124, 77, 255, 0.4);
      box-shadow: var(--shadow), var(--glow);
    }
    .modal header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(138, 149, 176, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal .body {
      padding: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }
    .power-card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      border: 1px solid rgba(138, 149, 176, 0.15);
    }
    .power-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
      border-color: var(--accent-2);
    }
    .power-card h4 {
      margin: 8px 0;
      font-size: 15px;
      font-weight: 700;
    }
    .power-card .cost {
      font-size: 12px;
      background: rgba(0, 212, 255, 0.2);
      color: #00d4ff;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-block;
    }

    .save-status {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(17, 17, 42, 0.9);
      color: var(--success);
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      box-shadow: var(--glow);
      opacity: 0;
      transition: opacity 0.4s;
      border: 1px solid rgba(0, 212, 255, 0.4);
    }
    .save-status.show {
      opacity: 1;
    }
    .footer {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="title">‚ú® Magic IT Class</div>
    <div style="display: flex; gap: 8px;">
      <button class="btn small primary" id="btnSave">üíæ Save</button>
      <button class="btn small ghost" id="btnUndo">‚Ü©Ô∏è Undo</button>
      <div class="dropdown">
        <button class="btn small ghost" id="btnAdminDropdown">‚öôÔ∏è</button>
        <div class="dropdown-content hidden" id="adminDropdown">
          <button class="btn small warning" id="btnReset">Reset All</button>
          <button class="btn small ghost" id="btnExport">üì¶ Backup</button>
          <button class="btn small ghost" id="btnImportJson">üìÇ Restore</button>
        </div>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <strong>üìö Classes</strong>
        <button class="btn small primary" id="btnAddClass">+ New</button>
      </div>
      <div class="class-list" id="classList"></div>

      <button class="btn small ghost" id="btnTogglePowers">üîÆ Manage Powers</button>
      <div class="card hidden" id="managePowersSection">
        <div class="card-body">
          <small class="muted">Add or remove superpowers.</small>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <input id="powerEmoji" placeholder="‚ú®" style="max-width: 60px;" />
            <input id="powerName" placeholder="New Power" style="flex: 1;" />
            <input id="powerCost" type="number" min="1" placeholder="20" style="max-width: 80px;" />
            <button class="btn small primary" id="btnAddPower">Add</button>
          </div>
          <div id="powerChips" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <strong>üì• Import Students</strong>
          <small class="muted">One name per line or CSV.</small>
          <textarea id="namesInput" placeholder="Ali&#10;Zarina&#10;Said"></textarea>
          <input type="file" id="fileCsv" accept=".csv,.txt" style="display: none;" />
          <button class="btn small" id="btnImportNames">Add Names</button>
          <button class="btn small ghost" id="btnUploadCsv">üìÅ Upload CSV</button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <section>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 20px 12px;">
        <div class="chip" id="activeClassChip">No class</div>
        <div style="display: flex; gap: 8px;">
          <button class="btn small" id="btnRenameClass">‚úèÔ∏è Rename</button>
          <button class="btn small" id="btnDeleteClass">üóëÔ∏è Delete</button>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 360px; gap: 20px; padding: 0 20px 20px;">
        <!-- Students Table -->
        <div class="panel">
          <div style="padding: 16px; border-bottom: 1px solid rgba(138,149,176,0.1);">
            <strong>üéì Students</strong>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th style="width: 5%">ü™Ñ</th>
                  <th style="width: 35%">Name</th>
                  <th style="width: 15%">Points</th>
                  <th style="width: 25%">Powers</th>
                  <th style="width: 20%">Actions</th>
                </tr>
              </thead>
              <tbody id="studentsBody"></tbody>
            </table>
          </div>
          <div style="padding: 16px; display: flex; justify-content: center; gap: 12px;">
            <button class="btn small" id="btnPrev">‚óÄÔ∏è Prev</button>
            <span class="muted" id="pageInfo">Page 1</span>
            <button class="btn small" id="btnNext">Next ‚ñ∂Ô∏è</button>
          </div>
        </div>

        <!-- Quick Rules -->
        <div class="panel">
          <div style="padding: 16px; border-bottom: 1px solid rgba(138,149,176,0.1);">
            <strong>‚ö° Quick Actions</strong>
          </div>
          <div class="card-body">
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
              <button class="btn small" data-delta="1">+1 ‚úÖ</button>
              <button class="btn small" data-delta="5">+5 üåü</button>
              <button class="btn small warning" data-delta="-2">-2 ‚ö†Ô∏è</button>
              <button class="btn small warning" data-delta="-5">-5 ‚ùå</button>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="number" id="customDelta" placeholder="¬± Custom" style="max-width: 100px;" />
              <button class="btn small" id="btnApplyCustom">Apply</button>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">‚ú® Magic IT Class ‚Ä¢ All data saved locally</div>
    </section>
  </div>

  <!-- Shop Modal -->
  <div class="modal-backdrop hidden" id="shopModal">
    <div class="modal">
      <header>
        <div><strong>üõí Superpowers Shop</strong></div>
        <button class="btn icon" id="closeShop">‚úñ</button>
      </header>
      <div class="body">
        <p class="muted">Select a student, then buy a power!</p>
        <div class="grid" id="shopGrid"></div>
      </div>
    </div>
  </div>

  <!-- Confirm Reset Modal -->
  <div class="modal-backdrop hidden" id="confirmResetModal">
    <div class="modal" style="max-width: 400px;">
      <header><strong>‚ö†Ô∏è Confirm Reset</strong></header>
      <div class="body">
        <p>This will erase everything. Are you sure?</p>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px;">
          <button class="btn small ghost" id="cancelReset">Cancel</button>
          <button class="btn small warning" id="confirmReset">Yes, Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Status -->
  <div class="save-status" id="saveStatus"></div>

  <!-- Audio -->
  <audio id="clickSfx" src="https://assets.codepen.io/314584/click.mp3" preload="auto"></audio>
  <audio id="purchaseSfx" src="https://assets.codepen.io/314584/purchase.mp3" preload="auto"></audio>
  <audio id="saveSfx" src="https://assets.codepen.io/314584/save.mp3" preload="auto"></audio>

  <script>
  // SFX
  function playSfx(id) {
    const audio = document.getElementById(id);
    audio.currentTime = 0;
    audio.play().catch(() => {});
  }

  // Sparkle Effect
  function createSparkle(x, y) {
    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle';
    sparkle.style.left = `${x}px`;
    sparkle.style.top = `${y}px`;
    document.body.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 1200);
  }

  // Confetti Explosion
  function launchConfetti() {
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * window.innerWidth + 'px';
      confetti.style.bottom = '20px';
      confetti.style.backgroundColor = ['#ff0', '#0ff', '#f0f', '#0f0', '#f80'][Math.floor(Math.random() * 5)];
      confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
      document.body.appendChild(confetti);

      const animation = confetti.animate([
        { transform: 'translate(0, 0) rotate(0)', opacity: 1 },
        { transform: `translate(${Math.random() * 400 - 200}px, -1000px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
      ], {
        duration: 3000 + Math.random() * 2000,
        easing: 'cubic-bezier(0.2, 0.8, 0.8, 0.2)'
      });
      animation.onfinish = () => confetti.remove();
    }
  }

  (function () {
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const DB_NAME = 'MagicITClassDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'appState';
    const ITEMS_PER_PAGE = 15;

    const defaultPowers = [
      { id: uid(), emoji: 'üéµ', name: 'Summon Music (5 min)', cost: 20 },
      { id: uid(), emoji: '‚è≥', name: 'Time Turner', cost: 30 },
      { id: uid(), emoji: 'üëë', name: "Wizard's Throne", cost: 40 },
      { id: uid(), emoji: '‚ùÑÔ∏è', name: 'Freeze Spell', cost: 50 },
      { id: uid(), emoji: 'ü™Ñ', name: 'Magic Helper', cost: 60 },
      { id: uid(), emoji: 'üéÅ', name: 'Mystery Chest', cost: 100 },
    ];

    let state = {
      classes: [],
      powers: defaultPowers,
      ui: { activeClassId: null, selectedStudentId: null, currentPage: 1 },
      history: [],
      __historyLastSave: 0
    };
    let renderRequest = null;
    let saveTimeout = null;

    // --- IndexedDB Wrapper ---
    const DB = {
      db: null,
      async open() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);
          req.onerror = () => reject(req.error);
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
          };
          req.onsuccess = (e) => {
            this.db = e.target.result;
            resolve(this.db);
          };
        });
      },
      async get(key) {
        const db = this.db || await this.open();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readonly');
          const store = tx.objectStore(STORE_NAME);
          const req = store.get(key);
          req.onsuccess = () => resolve(req.result?.data || null);
          req.onerror = () => reject(req.error);
        });
      },
      async put(key, value) {
        const db = this.db || await this.open();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);
          store.put({ id: key, data: value });
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      }
    };

    function uid() { return 'id-' + Math.random().toString(36).slice(2, 9); }

    // --- Save & Load ---
    async function save() {
      try {
        await DB.put('state', state);
        showSaveStatus('‚úÖ Saved!');
        playSfx('saveSfx');
      } catch (e) {
        console.error('Save failed:', e);
        showSaveStatus('‚ùå Failed');
      }
    }

    function showSaveStatus(msg) {
      const el = $('#saveStatus');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }

    async function load() {
      return await DB.get('state');
    }

    function pushHistory() {
      const now = Date.now();
      if (now - state.__historyLastSave < 2000) return;
      state.__historyLastSave = now;
      try {
        state.history.push(JSON.stringify({
          classes: state.classes,
          powers: state.powers,
          ui: { activeClassId: state.ui.activeClassId, selectedStudentId: state.ui.selectedStudentId }
        }));
        if (state.history.length > 20) state.history.shift();
      } catch (e) {
        console.warn("Failed to push history", e);
      }
    }

    function undo() {
      const snap = state.history.pop();
      if (!snap) return;
      try {
        Object.assign(state, JSON.parse(snap));
        scheduleRender();
      } catch (e) {
        console.error("Undo failed", e);
      }
    }

    function scheduleRender() {
      if (!renderRequest) {
        renderRequest = requestAnimationFrame(() => {
          renderAll();
          renderRequest = null;
        });
      }
    }

    // --- Actions ---
    function addClass() {
      const name = prompt('Class name (e.g., 7A):');
      if (!name) return;
      pushHistory();
      const cls = { id: uid(), name: name.trim(), students: [] };
      state.classes.push(cls);
      state.ui.activeClassId = cls.id;
      state.ui.currentPage = 1;
      debouncedSave();
      scheduleRender();
    }

    function deleteClass() {
      const cls = getActiveClass();
      if (!cls) return;
      if (!confirm(`Delete class "${cls.name}"?`)) return;
      pushHistory();
      state.classes = state.classes.filter(c => c.id !== cls.id);
      state.ui.activeClassId = state.classes[0]?.id || null;
      state.ui.selectedStudentId = null;
      state.ui.currentPage = 1;
      debouncedSave();
      scheduleRender();
    }

    function renameClass() {
      const cls = getActiveClass();
      if (!cls) return;
      const name = prompt('Rename class:', cls.name);
      if (!name) return;
      pushHistory();
      cls.name = name.trim();
      debouncedSave();
      scheduleRender();
    }

    function addStudent(name) {
      const cls = getActiveClass();
      if (!cls) return alert('Select a class first.');
      const clean = (name || '').trim();
      if (!clean) return;
      if (cls.students.some(s => s.name.toLowerCase() === clean.toLowerCase())) return;
      pushHistory();
      cls.students.push({ id: uid(), name: clean, points: 0, powers: [] });
      debouncedSave();
      scheduleRender();
    }

    function removeStudent(stu) {
      const cls = getActiveClass();
      if (!cls) return;
      if (!confirm(`Remove ${stu.name}?`)) return;
      pushHistory();
      cls.students = cls.students.filter(s => s.id !== stu.id);
      if (state.ui.selectedStudentId === stu.id) state.ui.selectedStudentId = null;
      const totalPages = Math.ceil(cls.students.length / ITEMS_PER_PAGE);
      if (state.ui.currentPage > totalPages && totalPages > 0) {
        state.ui.currentPage = totalPages;
      }
      debouncedSave();
      scheduleRender();
    }

    function renameStudent(stu) {
      const name = prompt('Rename student:', stu.name);
      if (!name) return;
      pushHistory();
      stu.name = name.trim();
      debouncedSave();
      scheduleRender();
    }

    function changePoints(stu, delta) {
      pushHistory();
      const oldPoints = stu.points || 0;
      stu.points = oldPoints + delta;
      if (delta > 0) createSparkle(event.clientX, event.clientY);
      if (stu.points >= 100 && delta > 0) launchConfetti();
      debouncedSave();
      scheduleRender();
    }

    function applyCustomToSelected() {
      const delta = parseInt($('#customDelta').value, 10);
      if (!delta) return;
      const stu = getActiveStudent();
      if (!stu) return alert('Select a student first.');
      changePoints(stu, delta);
    }

    function purchasePower(powerId) {
      const stu = getActiveStudent();
      if (!stu) return alert('Select a student first.');
      const p = state.powers.find(x => x.id === powerId);
      if (!p) return;
      if (stu.points < p.cost) return alert(`${stu.name} needs ${p.cost} pts!`);
      playSfx('purchaseSfx');
      stu.points -= p.cost;
      stu.powers.push({ id: p.id, ts: Date.now() });
      createSparkle(event.clientX, event.clientY);
      if (stu.points >= 100) launchConfetti();
      debouncedSave();
      scheduleRender();
    }

    function addPowerFromInputs() {
      const emoji = ($('#powerEmoji').value || '‚ú®').trim();
      const name = ($('#powerName').value || '').trim();
      const cost = parseInt($('#powerCost').value, 10) || 10;
      if (!name) return alert('Enter power name.');
      pushHistory();
      state.powers.push({ id: uid(), emoji, name, cost });
      $('#powerEmoji').value = '';
      $('#powerName').value = '';
      $('#powerCost').value = '';
      debouncedSave();
      renderPowers();
      buildShop();
    }

    function removePowerFromStudent(studentId, powerId) {
      const cls = getActiveClass();
      const stu = cls?.students.find(s => s.id === studentId);
      if (!stu) return;
      stu.powers = stu.powers.filter(p => p.id !== powerId);
      debouncedSave();
      scheduleRender();
    }

    function importNamesFromTextarea() {
      const cls = getActiveClass();
      if (!cls) return alert('Select a class first.');
      const text = ($('#namesInput').value || '').trim();
      if (!text) return;
      const names = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const unique = names.filter(n => !cls.students.some(s => s.name.toLowerCase() === n.toLowerCase()));
      if (!unique.length) return alert('No new names to add.');
      pushHistory();
      unique.forEach(n => cls.students.push({ id: uid(), name: n, points: 0, powers: [] }));
      $('#namesInput').value = '';
      state.ui.currentPage = 1;
      debouncedSave();
      scheduleRender();
    }

    function importCsvFile(file) {
      if (file.size > 1e6) return alert("File too large (max 1MB)");
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result || '';
        const names = text.split(/\r?\n/).map(line => line.split(',')[0].trim()).filter(Boolean);
        const textarea = $('#namesInput');
        textarea.value = ((textarea.value || '') + '\n' + names.join('\n')).trim();
        $('#fileCsv').value = '';
      };
      reader.readAsText(file);
    }

    function giveAll(delta) {
      const cls = getActiveClass();
      if (!cls) return;
      pushHistory();
      cls.students.forEach(s => s.points = (s.points || 0) + delta);
      debouncedSave();
      scheduleRender();
    }

    function exportJson() {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'magic_it_class_backup.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importJson() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = () => {
        const f = input.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const obj = JSON.parse(r.result);
            if (!obj || !obj.classes) throw new Error('Invalid format');
            pushHistory();
            state = obj;
            state.ui.currentPage = 1;
            debouncedSave();
            scheduleRender();
          } catch (e) {
            alert('Invalid JSON file');
          }
        };
        r.readAsText(f);
      };
      input.click();
    }

    function resetAll() {
      if (!confirm('This will erase all data. Continue?')) return;
      pushHistory();
      state = {
        classes: [],
        powers: defaultPowers.map(p => ({...p})),
        ui: { activeClassId: null, selectedStudentId: null, currentPage: 1 },
        history: [],
        __historyLastSave: 0
      };
      debouncedSave();
      scheduleRender();
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;', '<':'<', '>':'>', '"':'&quot;'}[s]));
    }

    function debouncedSave() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(save, 500);
    }

    // --- Rendering ---
    function renderAll() {
      renderClasses();
      renderPowers();
      renderStudents();
      updateActiveClassChip();
      buildShop();
      updatePagination();
    }

    function renderClasses() {
      const list = $('#classList');
      list.innerHTML = '';
      state.classes.forEach(cls => {
        const div = document.createElement('div');
        div.className = 'class-item' + (cls.id === state.ui.activeClassId ? ' active' : '');
        div.innerHTML = `
          <div>
            <strong>${escapeHtml(cls.name)}</strong>
            <small class="muted">${cls.students.length} students</small>
          </div>
          <div class="chip">Avg: ${avgPoints(cls)}</div>`;
        div.onclick = () => {
          state.ui.activeClassId = cls.id;
          state.ui.selectedStudentId = null;
          state.ui.currentPage = 1;
          scheduleRender();
        };
        list.appendChild(div);
      });
    }

    function avgPoints(cls) {
      const sum = cls.students.reduce((a, s) => a + (s.points || 0), 0);
      return Math.round(sum / (cls.students.length || 1));
    }

    function updateActiveClassChip() {
      const chip = $('#activeClassChip');
      const cls = getActiveClass();
      chip.textContent = cls ? `${cls.name} ‚Äî ${cls.students.length} students` : 'No class selected';
    }

    function getActiveClass() {
      return state.classes.find(c => c.id === state.ui.activeClassId) || null;
    }

    function getActiveStudent() {
      const cls = getActiveClass();
      return cls?.students.find(s => s.id === state.ui.selectedStudentId) || null;
    }

    function renderStudents() {
      const body = $('#studentsBody');
      body.innerHTML = '';
      const cls = getActiveClass();
      if (!cls) {
        body.innerHTML = `<tr><td colspan="5" class="muted">Select or create a class.</td></tr>`;
        return;
      }

      const sorted = [...cls.students].sort((a, b) => b.points - a.points);
      const start = (state.ui.currentPage - 1) * ITEMS_PER_PAGE;
      const page = sorted.slice(start, start + ITEMS_PER_PAGE);

      page.forEach(stu => {
        const tr = document.createElement('tr');
        tr.dataset.id = stu.id;
        if (state.ui.selectedStudentId === stu.id) {
          tr.style.outline = '2px solid var(--accent-2)';
        }
        tr.innerHTML = `
          <td><div class="drag-handle">ü™Ñ</div></td>
          <td><strong>${escapeHtml(stu.name)}</strong></td>
          <td class="pts">${stu.points || 0}</td>
          <td>${stu.powers.map(p => renderPowerIcon(p, stu.id)).join(' ')}</td>
          <td>
            <button class="btn small" onclick="purchasePowerFor('${stu.id}')">üõí Buy</button>
          </td>`;
        body.appendChild(tr);
      });
    }

    function renderPowerIcon(powerId, studentId) {
      const p = state.powers.find(x => x.id === powerId.id) || { emoji: '‚ùì' };
      return `
        <span class="power-chip" title="${p.name}">
          ${p.emoji}
          <span class="remove-power" onclick="removePowerFromStudent('${studentId}', '${powerId.id}')">√ó</span>
        </span>`;
    }

    function renderPowers() {
      const wrap = $('#powerChips');
      wrap.innerHTML = '';
      state.powers.forEach(p => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.title = `${p.emoji} ${p.name} (${p.cost})`;
        chip.innerHTML = `${p.emoji} ${escapeHtml(p.name)} <small>(${p.cost})</small>`;
        wrap.appendChild(chip);
      });
    }

    function buildShop() {
      const grid = $('#shopGrid');
      grid.innerHTML = '';
      state.powers.forEach(p => {
        const card = document.createElement('div');
        card.className = 'power-card';
        card.innerHTML = `
          <div style="font-size:28px">${p.emoji}</div>
          <h4>${escapeHtml(p.name)}</h4>
          <div class="cost">${p.cost} pts</div>`;
        card.onclick = () => purchasePower(p.id);
        grid.appendChild(card);
      });
    }

    function openShop() {
      $('#shopModal').classList.remove('hidden');
    }

    function closeShop() {
      $('#shopModal').classList.add('hidden');
    }

    function updatePagination() {
      const cls = getActiveClass();
      if (!cls) return;
      const totalPages = Math.ceil(cls.students.length / ITEMS_PER_PAGE);
      $('#pageInfo').textContent = `Page ${state.ui.currentPage} of ${totalPages}`;
      $('#btnPrev').disabled = state.ui.currentPage <= 1;
      $('#btnNext').disabled = state.ui.currentPage >= totalPages;
    }

    // --- Event Listeners ---
    function attachEventListeners() {
      $('#btnAddClass').onclick = addClass;
      $('#btnDeleteClass').onclick = deleteClass;
      $('#btnRenameClass').onclick = renameClass;
      $('#btnAddStudent').onclick = () => {
        const name = prompt('Student name:');
        if (name) addStudent(name);
      };
      $('#btnGiveAll').onclick = () => giveAll(1);
      $('#btnOpenShop').onclick = openShop;
      $('#closeShop').onclick = closeShop;
      $('#btnAddPower').onclick = addPowerFromInputs;
      $('#btnImportNames').onclick = importNamesFromTextarea;
      $('#btnUploadCsv').onclick = () => $('#fileCsv').click();
      $('#fileCsv').onchange = (e) => importCsvFile(e.target.files[0]);
      $('#btnApplyCustom').onclick = applyCustomToSelected;
      $('#btnExport').onclick = exportJson;
      $('#btnImportJson').onclick = importJson;
      $('#btnSave').onclick = async () => {
        clearTimeout(saveTimeout);
        await save();
      };
      $('#btnUndo').onclick = undo;
      $('#btnReset').onclick = () => {
        $('#confirmResetModal').classList.remove('hidden');
      };
      $('#cancelReset').onclick = () => {
        $('#confirmResetModal').classList.add('hidden');
      };
      $('#confirmReset').onclick = () => {
        resetAll();
        $('#confirmResetModal').classList.add('hidden');
      };
      $('#btnTogglePowers').onclick = () => {
        $('#managePowersSection').classList.toggle('hidden');
      };
      $('#btnAdminDropdown').onclick = (e) => {
        e.stopPropagation();
        $('#adminDropdown').classList.toggle('show');
      };
      document.addEventListener('click', () => {
        $('#adminDropdown').classList.remove('show');
      });

      // Quick delta buttons
      $$('.btn[data-delta]').forEach(btn => {
        btn.onclick = () => {
          const delta = parseInt(btn.dataset.delta);
          const stu = getActiveStudent();
          if (stu) changePoints(stu, delta);
        };
      });
    }

    // --- Init ---
    async function init() {
      await DB.open();
      const saved = await load();
      if (saved) state = saved;

      if (!state.classes.length) {
        const sample = {
          id: uid(),
          name: '7A',
          students: [
            { id: uid(), name: 'Ali', points: 3, powers: [] },
            { id: uid(), name: 'Zarina', points: 1, powers: [] },
            { id: uid(), name: 'Said', points: 0, powers: [] },
          ]
        };
        state.classes.push(sample);
        state.ui.activeClassId = sample.id;
        await save();
      }

      renderAll();
      attachEventListeners();
    }

    // Make functions globally available for onclick
    window.purchasePowerFor = (id) => {
      state.ui.selectedStudentId = id;
      openShop();
    };
    window.removePowerFromStudent = removePowerFromStudent;

    // Start the app
    init();
  })();
</script>
</body>
</html>
